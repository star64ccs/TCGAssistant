name: Monitoring and Alerts

on:
  schedule:
    # æ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ‡‰ç”¨ç¨‹åºå¥åº·ç‹€æ…‹
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of health check'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - health
        - performance
        - security
        - uptime

jobs:
  # æ‡‰ç”¨ç¨‹åºå¥åº·æª¢æŸ¥
  health-check:
    name: Application Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Check frontend health
      run: |
        echo "Checking frontend health"
        # æª¢æŸ¥å‰ç«¯æ‡‰ç”¨ç¨‹åºç‹€æ…‹
        curl -f https://tcg-assistant.vercel.app/ || echo "Frontend health check failed"
        
    - name: Check backend health
      run: |
        echo "Checking backend health"
        # æª¢æŸ¥å¾Œç«¯APIç‹€æ…‹
        curl -f https://api.tcg-assistant.com/health || echo "Backend health check failed"
        
    - name: Check database connectivity
      run: |
        echo "Checking database connectivity"
        # æª¢æŸ¥æ•¸æ“šåº«é€£æ¥ç‹€æ…‹
        
    - name: Check external services
      run: |
        echo "Checking external services"
        # æª¢æŸ¥ç¬¬ä¸‰æ–¹æœå‹™ç‹€æ…‹ï¼ˆå¦‚æ”¯ä»˜ã€é€šçŸ¥ç­‰ï¼‰
        
    - name: Generate health report
      run: |
        echo "Generating health report"
        # ç”Ÿæˆå¥åº·ç‹€æ…‹å ±å‘Š

  # æ€§èƒ½ç›£æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: health-check
    
    steps:
    - name: Check frontend performance
      run: |
        echo "Checking frontend performance"
        # ä½¿ç”¨ Lighthouse CI æª¢æŸ¥å‰ç«¯æ€§èƒ½
        # npx lighthouse https://tcg-assistant.vercel.app/ --output=json --output-path=./lighthouse-report.json
        
    - name: Check API response times
      run: |
        echo "Checking API response times"
        # æª¢æŸ¥APIéŸ¿æ‡‰æ™‚é–“
        start_time=$(date +%s.%N)
        curl -s https://api.tcg-assistant.com/health > /dev/null
        end_time=$(date +%s.%N)
        response_time=$(echo "$end_time - $start_time" | bc)
        echo "API response time: ${response_time}s"
        
        # å¦‚æœéŸ¿æ‡‰æ™‚é–“è¶…éé–¾å€¼ï¼Œè§¸ç™¼è­¦å ±
        if (( $(echo "$response_time > 2.0" | bc -l) )); then
          echo "WARNING: API response time is slow: ${response_time}s"
          exit 1
        fi
        
    - name: Check memory usage
      run: |
        echo "Checking memory usage"
        # æª¢æŸ¥æ‡‰ç”¨ç¨‹åºå…§å­˜ä½¿ç”¨æƒ…æ³
        
    - name: Check CPU usage
      run: |
        echo "Checking CPU usage"
        # æª¢æŸ¥CPUä½¿ç”¨æƒ…æ³
        
    - name: Check disk space
      run: |
        echo "Checking disk space"
        # æª¢æŸ¥ç£ç›¤ç©ºé–“ä½¿ç”¨æƒ…æ³
        
    - name: Generate performance report
      run: |
        echo "Generating performance report"
        # ç”Ÿæˆæ€§èƒ½ç›£æ§å ±å‘Š

  # å®‰å…¨ç›£æ§
  security-monitoring:
    name: Security Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: performance-monitoring
    
    steps:
    - name: Check for security vulnerabilities
      run: |
        echo "Checking for security vulnerabilities"
        # æª¢æŸ¥ä¾è³´é …å®‰å…¨æ¼æ´
        npm audit --audit-level=moderate || echo "Security vulnerabilities found"
        
    - name: Check SSL certificate
      run: |
        echo "Checking SSL certificate"
        # æª¢æŸ¥SSLè­‰æ›¸æœ‰æ•ˆæœŸ
        openssl s_client -connect tcg-assistant.vercel.app:443 -servername tcg-assistant.vercel.app < /dev/null 2>/dev/null | openssl x509 -noout -dates
        
    - name: Check for suspicious activities
      run: |
        echo "Checking for suspicious activities"
        # æª¢æŸ¥å¯ç–‘æ´»å‹•ï¼ˆå¦‚ç•°å¸¸ç™»éŒ„ã€å¤§é‡è«‹æ±‚ç­‰ï¼‰
        
    - name: Check firewall status
      run: |
        echo "Checking firewall status"
        # æª¢æŸ¥é˜²ç«ç‰†ç‹€æ…‹
        
    - name: Generate security report
      run: |
        echo "Generating security report"
        # ç”Ÿæˆå®‰å…¨ç›£æ§å ±å‘Š

  # å¯ç”¨æ€§ç›£æ§
  uptime-monitoring:
    name: Uptime Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: security-monitoring
    
    steps:
    - name: Check frontend uptime
      run: |
        echo "Checking frontend uptime"
        response=$(curl -s -o /dev/null -w "%{http_code}" https://tcg-assistant.vercel.app/)
        if [ "$response" != "200" ]; then
          echo "ERROR: Frontend is down (HTTP $response)"
          exit 1
        fi
        echo "Frontend is up and running"
        
    - name: Check backend uptime
      run: |
        echo "Checking backend uptime"
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.tcg-assistant.com/health)
        if [ "$response" != "200" ]; then
          echo "ERROR: Backend is down (HTTP $response)"
          exit 1
        fi
        echo "Backend is up and running"
        
    - name: Check mobile app status
      run: |
        echo "Checking mobile app status"
        # æª¢æŸ¥ç§»å‹•æ‡‰ç”¨åœ¨æ‡‰ç”¨å•†åº—çš„ç‹€æ…‹
        
    - name: Calculate uptime percentage
      run: |
        echo "Calculating uptime percentage"
        # è¨ˆç®—æ‡‰ç”¨ç¨‹åºå¯ç”¨æ€§ç™¾åˆ†æ¯”

  # éŒ¯èª¤ç›£æ§
  error-monitoring:
    name: Error Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: uptime-monitoring
    
    steps:
    - name: Check error logs
      run: |
        echo "Checking error logs"
        # æª¢æŸ¥æ‡‰ç”¨ç¨‹åºéŒ¯èª¤æ—¥èªŒ
        
    - name: Check crash reports
      run: |
        echo "Checking crash reports"
        # æª¢æŸ¥å´©æ½°å ±å‘Š
        
    - name: Check failed transactions
      run: |
        echo "Checking failed transactions"
        # æª¢æŸ¥å¤±æ•—çš„äº¤æ˜“
        
    - name: Check API errors
      run: |
        echo "Checking API errors"
        # æª¢æŸ¥APIéŒ¯èª¤ç‡
        
    - name: Generate error report
      run: |
        echo "Generating error report"
        # ç”ŸæˆéŒ¯èª¤ç›£æ§å ±å‘Š

  # è‡ªå‹•è­¦å ±
  alerts:
    name: Automated Alerts
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, security-monitoring, uptime-monitoring, error-monitoring]
    timeout-minutes: 10
    if: always()
    
    steps:
    - name: Check for critical issues
      run: |
        echo "Checking for critical issues"
        # æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡å•é¡Œéœ€è¦ç«‹å³é€šçŸ¥
        
    - name: Send Slack notification
      if: failure()
      run: |
        echo "Sending Slack notification for failure"
        # ç™¼é€ Slack é€šçŸ¥
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ TCG Assistant monitoring alert: One or more checks failed"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Send email alert
      if: failure()
      run: |
        echo "Sending email alert for failure"
        # ç™¼é€éƒµä»¶è­¦å ±
        
    - name: Create GitHub issue
      if: failure()
      run: |
        echo "Creating GitHub issue for failure"
        # å‰µå»º GitHub issue è¨˜éŒ„å•é¡Œ
        
    - name: Update status page
      run: |
        echo "Updating status page"
        # æ›´æ–°ç‹€æ…‹é é¢
        
    - name: Generate monitoring report
      run: |
        echo "Generating comprehensive monitoring report"
        # ç”Ÿæˆå®Œæ•´çš„ç›£æ§å ±å‘Š
        
    - name: Upload monitoring artifacts
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring-results/
        retention-days: 7

  # å®šæœŸç¶­è­·
  maintenance:
    name: Scheduled Maintenance
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.schedule == '0 2 * * 0'  # æ¯é€±æ—¥å‡Œæ™¨2é»
    
    steps:
    - name: Database cleanup
      run: |
        echo "Running database cleanup"
        # æ¸…ç†éæœŸçš„æ—¥èªŒå’Œè‡¨æ™‚æ•¸æ“š
        
    - name: Cache cleanup
      run: |
        echo "Running cache cleanup"
        # æ¸…ç†éæœŸçš„ç·©å­˜
        
    - name: Log rotation
      run: |
        echo "Running log rotation"
        # è¼ªæ›æ—¥èªŒæ–‡ä»¶
        
    - name: Backup creation
      run: |
        echo "Creating backup"
        # å‰µå»ºæ•¸æ“šå‚™ä»½
        
    - name: Dependency updates
      run: |
        echo "Checking for dependency updates"
        # æª¢æŸ¥ä¾è³´é …æ›´æ–°
        
    - name: Performance optimization
      run: |
        echo "Running performance optimization"
        # é‹è¡Œæ€§èƒ½å„ªåŒ–
        
    - name: Generate maintenance report
      run: |
        echo "Generating maintenance report"
        # ç”Ÿæˆç¶­è­·å ±å‘Š
