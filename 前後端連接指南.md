# TCG助手前後端連接指南

## 📋 概述

本指南將幫助您成功連接TCG助手的前端和後端服務。

## 🔧 環境配置

### 1. 端口配置統一

**重要：確保前後端使用相同的端口**

- **前端配置**：`REACT_APP_API_URL=http://localhost:3000`
- **後端配置**：`PORT=3000`
- **測試服務器**：端口3000

### 2. 環境變數設置

#### 前端環境變數 (根目錄 `.env`)
```bash
# API配置
REACT_APP_API_URL=http://localhost:3000
REACT_APP_FEATURE_REAL_API=true
REACT_APP_FEATURE_MOCK_FALLBACK=true
```

#### 後端環境變數 (backend/.env)
```bash
# 服務器配置
NODE_ENV=development
PORT=3000
API_VERSION=v1

# 安全配置
CORS_ORIGIN=http://localhost:3000
```

## 🚀 啟動步驟

### 步驟1：啟動後端服務器

```bash
# 進入後端目錄
cd backend

# 安裝依賴（如果還沒安裝）
npm install

# 啟動測試服務器
node simple-test-server.js
```

**預期輸出：**
```
=== 簡單測試服務器 ===
開始創建Express應用程式...
Express應用程式創建成功
中間件配置完成
路由配置完成
嘗試在端口 3000 啟動服務器...
✅ 服務器成功啟動在端口 3000
🌐 服務器地址: http://localhost:3000
🔍 健康檢查: http://localhost:3000/health
🧪 測試端點: http://localhost:3000/test
📊 API端點: http://localhost:3000/api/v1
🚀 服務器已準備就緒！
```

### 步驟2：驗證後端服務器

在瀏覽器中訪問以下端點：

- **健康檢查**：http://localhost:3000/health
- **API端點**：http://localhost:3000/api/v1
- **用戶資料**：http://localhost:3000/api/v1/user/profile
- **卡牌資料**：http://localhost:3000/api/v1/cardData/pokemon

### 步驟3：啟動前端應用

```bash
# 在另一個終端中，進入項目根目錄
cd TCGAssistant

# 啟動前端開發服務器
npm start
# 或
expo start
```

### 步驟4：測試連接

使用我們提供的測試組件：

```javascript
// 在您的React Native應用中導入
import FrontendBackendConnectionTest from './src/examples/FrontendBackendConnectionTest';

// 在您的導航或主組件中使用
<FrontendBackendConnectionTest />
```

## 🔍 故障排除

### 問題1：端口被佔用

**症狀：** 服務器無法啟動，顯示端口被佔用錯誤

**解決方案：**
```bash
# 檢查端口使用情況
netstat -ano | findstr :3000

# 終止佔用端口的進程
taskkill /f /im node.exe

# 或使用不同的端口（需要同時修改前後端配置）
```

### 問題2：防火牆阻擋

**症狀：** 服務器啟動成功但無法從外部訪問

**解決方案：**
```powershell
# 以管理員身份運行PowerShell
# 添加防火牆規則
netsh advfirewall firewall add rule name="TCG-Backend-In" dir=in action=allow protocol=TCP localport=3000
netsh advfirewall firewall add rule name="TCG-Backend-Out" dir=out action=allow protocol=TCP localport=3000
```

### 問題3：CORS錯誤

**症狀：** 前端無法訪問後端API，瀏覽器顯示CORS錯誤

**解決方案：**
確保後端已正確配置CORS中間件：

```javascript
// 在後端服務器中
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
  } else {
    next();
  }
});
```

### 問題4：網絡連接失敗

**症狀：** 前端顯示"網絡連接失敗"錯誤

**解決方案：**
1. 確認後端服務器正在運行
2. 檢查端口配置是否一致
3. 確認防火牆設置
4. 檢查網絡連接

## 📱 測試API端點

### 基本端點

| 端點 | 方法 | 描述 | 預期響應 |
|------|------|------|----------|
| `/health` | GET | 健康檢查 | `{"success": true, "message": "服務器運行正常"}` |
| `/test` | GET | 測試端點 | `{"success": true, "message": "測試端點正常"}` |
| `/api/v1` | GET | API版本信息 | `{"success": true, "message": "API v1 端點正常"}` |

### 業務端點

| 端點 | 方法 | 描述 | 預期響應 |
|------|------|------|----------|
| `/api/v1/user/profile` | GET | 用戶資料 | `{"success": true, "data": {...}}` |
| `/api/v1/cardData/pokemon` | GET | 寶可夢卡牌資料 | `{"success": true, "data": [...], "pagination": {...}}` |

## 🔧 開發工具

### 1. 使用測試組件

我們提供了完整的測試組件 `FrontendBackendConnectionTest.js`，包含：

- 基本連接測試
- API端點測試
- 用戶資料測試
- 卡牌資料測試
- 增強API服務測試
- 批量測試功能

### 2. 使用增強的API服務

```javascript
import enhancedApiService from './src/services/enhancedApiService';

// 基本GET請求
const data = await enhancedApiService.get('/api/v1/user/profile');

// 帶緩存的請求
const cachedData = await enhancedApiService.get('/api/v1/cardData/pokemon', {}, {
  useCache: true,
  cacheKey: 'pokemon_cards'
});

// 文件上傳
const uploadResult = await enhancedApiService.uploadFile('/api/v1/upload', file);
```

### 3. 使用Redux Toolkit

```javascript
import { useDispatch, useSelector } from 'react-redux';
import { fetchUserProfile, selectUserProfile } from './src/store/slices/enhancedUserSlice';

// 在組件中使用
const dispatch = useDispatch();
const userProfile = useSelector(selectUserProfile);

useEffect(() => {
  dispatch(fetchUserProfile());
}, [dispatch]);
```

## 📊 監控和日誌

### 後端日誌

後端服務器會輸出詳細的日誌信息：

```
收到健康檢查請求
收到測試請求
收到API請求: /api/v1/user/profile
```

### 前端日誌

前端會在控制台輸出API調用信息：

```
API請求: GET /api/v1/user/profile
API響應: 200 OK
緩存命中: pokemon_cards
```

## ✅ 成功指標

當您看到以下情況時，表示前後端連接成功：

1. ✅ 後端服務器啟動無錯誤
2. ✅ 瀏覽器可以訪問 http://localhost:3000/health
3. ✅ 前端測試組件顯示所有測試通過
4. ✅ 沒有CORS錯誤
5. ✅ API響應數據正確

## 🚀 下一步

連接成功後，您可以：

1. 開始開發新功能
2. 添加更多API端點
3. 實現真實的數據庫連接
4. 添加認證和授權
5. 部署到生產環境

## 📞 需要幫助？

如果遇到問題，請檢查：

1. 端口配置是否一致
2. 防火牆設置
3. 網絡連接
4. 服務器日誌
5. 瀏覽器控制台錯誤

---

**祝您開發順利！** 🎉
